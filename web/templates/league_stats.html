{% extends "base.html" %}

{% block title %}Teams - New Puck Analysis{% endblock %}
{% block nav_teams %}active{% endblock %}

{% block content %}
<!-- Tabs -->
<div class="tabs" style="margin-bottom:0; border-bottom:none;">
  <a href="{{ url_for('teams', season=season, game_state='5v5') }}"
    class="tab {% if game_state == '5v5' %}active{% endif %}">5v5</a>
  <a href="{{ url_for('teams', season=season, game_state='5v4') }}"
    class="tab {% if game_state == '5v4' %}active{% endif %}">5v4</a>
  <a href="{{ url_for('teams', season=season, game_state='4v5') }}"
    class="tab {% if game_state == '4v5' %}active{% endif %}">4v5</a>
  <a href="{{ url_for('teams', season=season, game_state='SpecialTeams') }}"
    class="tab {% if game_state == 'SpecialTeams' %}active{% endif %}">Special Teams</a>
</div>

<!-- Summary Table -->
<div class="card">
  <div class="card-header">
    <h2>League Summary ({{ game_state }})</h2>
  </div>
  <div class="card-body">
    {% if stats %}
    <div style="overflow-x: auto;">
      <table id="statsTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Team</th>
            <th class="num" onclick="sortTable(1, true)">GP</th>
            <th class="num" onclick="sortTable(2, true)">TOI</th>
            <th class="num" onclick="sortTable(3, true)">GF</th>
            <th class="num" onclick="sortTable(4, true)">GA</th>
            <th class="num" onclick="sortTable(5, true)">GF%</th>
            <th class="num" onclick="sortTable(6, true)">xGF</th>
            <th class="num" onclick="sortTable(7, true)">xGA</th>
            <th class="num" onclick="sortTable(8, true)">xGF%</th>
            <th class="num" onclick="sortTable(9, true)">CF</th>
            <th class="num" onclick="sortTable(10, true)">CA</th>
            <th class="num" onclick="sortTable(11, true)">CF%</th>
            <th class="num" onclick="sortTable(12, true)">xGF/60</th>
            <th class="num" onclick="sortTable(13, true)">xGA/60</th>
          </tr>
        </thead>
        <tbody>
          {% for row in stats %}
          <tr>
            <td>
              <a href="{{ url_for('team', team=row.Team) }}"
                style="color:var(--primary-color); text-decoration:none; font-weight:600;">
                {{ row.Team }}
              </a>
            </td>
            <td class="num">{{ row.GP }}</td>
            <td class="num">{{ row.TOI }}</td>
            <td class="num">{{ row.GF }}</td>
            <td class="num">{{ row.GA }}</td>
            <td class="num">{{ row['GF%'] }}</td>
            <td class="num">{{ row.xGF }}</td>
            <td class="num">{{ row.xGA }}</td>
            <td class="num">{{ row['xGF%'] }}</td>
            <td class="num">{{ row.CF }}</td>
            <td class="num">{{ row.CA }}</td>
            <td class="num">{{ row['CF%'] }}</td>
            <td class="num">{{ row['xGF/60'] }}</td>
            <td class="num">{{ row['xGA/60'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="empty-state">
      No league statistics available for {{ game_state }}. Please run the analysis script.
    </p>
    {% endif %}
  </div>
</div>

<!-- Scatter Plot -->
<div class="card">
  <div class="card-header">
    <h2>xG Rates Scatter ({{ game_state }})</h2>
  </div>
  <div class="card-body scatter-container">
    {% if scatter_img %}
    <img src="{{ url_for('analysis_file', filename=scatter_img) }}" alt="xG Scatter Plot" loading="lazy">
    {% else %}
    <p class="empty-state">
      No scatter plot available.
    </p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function sortTable(n, isNumeric = false) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("statsTable");
    switching = true;
    dir = "asc";

    // Reset headers
    var headers = table.getElementsByTagName("th");
    for (i = 0; i < headers.length; i++) {
      headers[i].classList.remove("sorted-asc", "sorted-desc");
    }

    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];

        // For the Team column (index 0), we need to get the text content of the link
        var xContent = (n === 0) ? x.innerText.toLowerCase() : x.innerHTML.toLowerCase();
        var yContent = (n === 0) ? y.innerText.toLowerCase() : y.innerHTML.toLowerCase();

        if (isNumeric) {
          xContent = parseFloat(xContent) || 0;
          yContent = parseFloat(yContent) || 0;
        }

        if (dir == "asc") {
          if (xContent > yContent) {
            shouldSwitch = true;
            break;
          }
        } else if (dir == "desc") {
          if (xContent < yContent) {
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount++;
      } else {
        if (switchcount == 0 && dir == "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }

    // Set header class
    if (dir == "asc") {
      headers[n].classList.add("sorted-asc");
    } else {
      headers[n].classList.add("sorted-desc");
    }
  }
</script>
{% endblock %}