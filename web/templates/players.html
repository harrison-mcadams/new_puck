{% extends "base.html" %}

{% block title %}Players - New Puck Analysis{% endblock %}
{% block nav_players %}active{% endblock %}

{% block content %}
<!-- Summary Table -->
<div class="card">
  <div class="card-header">
    <h2>Player Statistics</h2>
  </div>
  <div class="card-body">
    {% if players %}
    <div
      style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div>
        <label style="margin-right:0.5rem;">Show</label>
        <select id="pageSize" onchange="changePageSize()" style="width:auto; min-width:80px;">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>
        <span style="margin-left:0.5rem; color:var(--text-secondary); font-size:0.9rem;">entries</span>
      </div>
      <div>
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search players..."
          style="min-width:250px;">
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="statsTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Player</th>
            <th onclick="sortTable(1)">Team</th>
            <th class="num" onclick="sortTable(2, true)">GP</th>
            <th class="num" onclick="sortTable(3, true)">TOI</th>
            <th class="num" onclick="sortTable(4, true)">GF</th>
            <th class="num" onclick="sortTable(5, true)">GA</th>
            <th class="num" onclick="sortTable(6, true)">GF%</th>
            <th class="num" onclick="sortTable(7, true)">xGF</th>
            <th class="num" onclick="sortTable(8, true)">xGA</th>
            <th class="num" onclick="sortTable(9, true)">xGF%</th>
            <th class="num" onclick="sortTable(10, true)">CF</th>
            <th class="num" onclick="sortTable(11, true)">CA</th>
            <th class="num" onclick="sortTable(12, true)">CF%</th>
            <th class="num" onclick="sortTable(13, true)">xGF/60</th>
            <th class="num" onclick="sortTable(14, true)">xGA/60</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          {% for row in players %}
          <tr>
            <td>
              <a href="{{ url_for('player_view', season=season, team=row.team, player_id=row.player_id) }}"
                style="color:var(--primary-color); text-decoration:none; font-weight:600;">
                {{ row.name }}
              </a>
            </td>
            <td>{{ row.team }}</td>
            <td class="num">{{ row.games_played }}</td>
            <td class="num">{{ row.toi_min }}</td>
            <td class="num">{{ row.goals_for if row.goals_for is not none else '-' }}</td>
            <td class="num">{{ row.goals_against if row.goals_against is not none else '-' }}</td>
            <td class="num">{{ row.gf_pct if row.gf_pct is not none else '-' }}</td>
            <td class="num">{{ row.xg_for|round(1) if row.xg_for is not none else '-' }}</td>
            <td class="num">{{ row.xg_against|round(1) if row.xg_against is not none else '-' }}</td>
            <td class="num">{{ row.xgf_pct if row.xgf_pct is not none else '-' }}</td>
            <td class="num">{{ row.attempts_for if row.attempts_for is not none else '-' }}</td>
            <td class="num">{{ row.attempts_against if row.attempts_against is not none else '-' }}</td>
            <td class="num">{{ row.cf_pct if row.cf_pct is not none else '-' }}</td>
            <td class="num">{{ row.xg_for_60 }}</td>
            <td class="num">{{ row.xg_against_60 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pagination" id="paginationControls">
      <!-- Pagination buttons -->
    </div>

    {% else %}
    <p class="empty-state">
      No player statistics available.
    </p>
    {% endif %}
  </div>
</div>

<!-- Scatter Plot -->
<div class="card">
  <div class="card-header">
    <h2>League Player Scatter (5v5)</h2>
  </div>
  <div class="card-body scatter-container">
    {% if scatter_img %}
    <img src="{{ url_for('analysis_file', filename=scatter_img) }}" alt="Player Scatter Plot" loading="lazy">
    {% else %}
    <p class="empty-state">
      No scatter plot available.
    </p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let currentPage = 1;
  let pageSize = 50;
  let allRows = [];
  let filteredRows = [];

  document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('tableBody');
    if (tbody) {
      allRows = Array.from(tbody.rows);
      filteredRows = [...allRows];
      renderTable();
    }
  });

  function filterTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();

    filteredRows = allRows.filter(row => {
      const name = row.cells[0].innerText.toLowerCase();
      const team = row.cells[1].innerText.toLowerCase();
      return name.includes(filter) || team.includes(filter);
    });

    currentPage = 1;
    renderTable();
  }

  function changePageSize() {
    const select = document.getElementById('pageSize');
    pageSize = select.value === 'all' ? filteredRows.length : parseInt(select.value);
    currentPage = 1;
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageRows = filteredRows.slice(start, end);

    pageRows.forEach(row => tbody.appendChild(row));

    renderPagination();
  }

  function renderPagination() {
    const controls = document.getElementById('paginationControls');
    controls.innerHTML = '';

    const totalPages = Math.ceil(filteredRows.length / pageSize);
    if (totalPages <= 1) return;

    // Prev
    const prevBtn = document.createElement('button');
    prevBtn.innerText = 'Prev';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { currentPage--; renderTable(); };
    controls.appendChild(prevBtn);

    // Page Info
    const info = document.createElement('span');
    info.innerText = ` Page ${currentPage} of ${totalPages} `;
    info.style.alignSelf = 'center';
    info.style.fontSize = '0.9rem';
    info.style.color = 'var(--text-secondary)';
    controls.appendChild(info);

    // Next
    const nextBtn = document.createElement('button');
    nextBtn.innerText = 'Next';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { currentPage++; renderTable(); };
    controls.appendChild(nextBtn);
  }

  function sortTable(n, isNumeric = false) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("statsTable");
    switching = true;
    dir = "asc";

    // Reset headers
    var headers = table.getElementsByTagName("th");
    for (i = 0; i < headers.length; i++) {
      headers[i].classList.remove("sorted-asc", "sorted-desc");
    }

    // Sort the filteredRows array directly
    filteredRows.sort((a, b) => {
      let xContent = a.cells[n].innerText.toLowerCase();
      let yContent = b.cells[n].innerText.toLowerCase();

      if (xContent === '-') xContent = isNumeric ? -999999 : '';
      if (yContent === '-') yContent = isNumeric ? -999999 : '';

      if (isNumeric) {
        xContent = parseFloat(xContent) || 0;
        yContent = parseFloat(yContent) || 0;
      }

      if (xContent < yContent) return -1;
      if (xContent > yContent) return 1;
      return 0;
    });

    if (table.getAttribute('data-sort-col') == n && table.getAttribute('data-sort-dir') == 'asc') {
      filteredRows.reverse();
      dir = 'desc';
    } else {
      dir = 'asc';
    }

    table.setAttribute('data-sort-col', n);
    table.setAttribute('data-sort-dir', dir);

    // Set header class
    if (dir == "asc") {
      headers[n].classList.add("sorted-asc");
    } else {
      headers[n].classList.add("sorted-desc");
    }

    currentPage = 1;
    renderTable();
  }
</script>
{% endblock %}