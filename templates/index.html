<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Shot Plot</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 2rem; }
      /* remove default image border so the plot has no gray outline */
      img { max-width: 100%; height: auto; border: none; }
      .controls { margin-top: 1rem; display: flex; justify-content: center; align-items: center; }
      .controls form { display: flex; gap: 0.5rem; align-items: center; }
      .controls input[type="text"] { padding: 0.4rem 0.6rem; font-size: 0.95rem; }
      .controls button { padding: 0.45rem 0.8rem; font-size: 0.95rem; cursor: pointer; }
      /* Center the main plot image */
      .plot { display: flex; justify-content: center; align-items: center; margin-top: 1rem; }
      /* remove any shadow/outline for a clean image */
      .plot img { max-width: 900px; width: 100%; box-shadow: none; border: none; }
    </style>
  </head>
  <body>


    {% if exists %}
      <div class="plot">
        <img src="{{ url_for('static', filename=img) }}" alt="shot plot" />
      </div>
    {% else %}
      <p>No plot found. Run <code>python demo_plot.py</code> to fetch data and generate the plot.</p>
    {% endif %}

    <div class="controls">
      <div id="status" style="margin-right:1rem; font-size:0.95rem; color:#333">Enter a game ID and click Plot to regenerate the shot map.</div>
      <button id="refreshTeams" style="margin-left:0.5rem; padding:0.3rem 0.5rem;">Refresh teams</button>
      <form id="replotForm" action="{{ url_for('replot') }}" method="post">
        <div id="selectors" style="display:flex; gap:0.6rem; align-items:center;">
          <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <label for="team_select">Team: <span id="teamsCount" style="font-weight:normal; font-size:0.9rem; color:#666">(0)</span></label>
            <select id="team_select" name="team_select" style="min-width:180px;">
              <option value="">-- select team --</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <label for="game_select">Team games:</label>
            <select id="game_select" name="game_select" style="min-width:260px;">
              <option value="">-- select game --</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <label for="game_manual">Or enter Game ID:</label>
            <input type="text" id="game_manual" name="game_manual" placeholder="e.g. 2025020196" style="min-width:160px;" />
          </div>
        </div>
        <!-- hidden field the server expects -->
        <input type="hidden" id="game" name="game" value="" />

        <button type="submit">Plot</button>
      </form>
    </div>
    <script>
      (function(){
        const teamSelect = document.getElementById('team_select');
        const gameSelect = document.getElementById('game_select');
        const manualInput = document.getElementById('game_manual');
        const hiddenInput = document.getElementById('game');
        const form = document.getElementById('replotForm');
        const refreshBtn = document.getElementById('refreshTeams');
        const teamsCount = document.getElementById('teamsCount');
        const statusEl = document.getElementById('status');

        function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

        const FALLBACK_TEAMS = [
          {abbr: 'BOS', name: 'Bruins'},
          {abbr: 'NYR', name: 'Rangers'},
          {abbr: 'PHI', name: 'Flyers'},
          {abbr: 'PIT', name: 'Penguins'},
          {abbr: 'TOR', name: 'Maple Leafs'},
          {abbr: 'CHI', name: 'Blackhawks'}
        ];

        function updateTeamsCount(n){
          if(teamsCount) teamsCount.textContent = `(${n})`;
        }

        function clearGames(){
          gameSelect.innerHTML = '<option value="">-- select game --</option>';
        }

        function populateTeamSelect(teams){
          teamSelect.disabled = true;
          refreshBtn.disabled = true;
          teamSelect.innerHTML = '<option value="">-- select team --</option>';
          clearGames();
          if(!Array.isArray(teams) || teams.length === 0) teams = FALLBACK_TEAMS;
          teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = (t.abbr || t.abbreviation || t.code || '').toString();
            opt.textContent = `${opt.value} - ${t.name || t.teamName || ''}`;
            teamSelect.appendChild(opt);
          });
          updateTeamsCount(teams.length);
          teamSelect.disabled = false;
          refreshBtn.disabled = false;
          try{ teamSelect.focus(); }catch(e){}
          setStatus(`${teams.length} teams loaded`);
        }

        async function loadTeams(){
          setStatus('Loading teams...');
          refreshBtn.disabled = true;
          try{
            const res = await fetch('/api/teams');
            if(!res.ok){
              console.warn('Failed /api/teams status', res.status);
              populateTeamSelect(FALLBACK_TEAMS);
              setStatus('Using fallback teams (could not fetch remote list).');
              return;
            }
            const teams = await res.json();
            if(!teams || !Array.isArray(teams) || teams.length === 0){
              populateTeamSelect(FALLBACK_TEAMS);
              setStatus('Using fallback teams (API returned no teams).');
              return;
            }
            populateTeamSelect(teams);
            setStatus('Select a team to load its games.');
          }catch(err){
            console.error('Error loading teams:', err);
            populateTeamSelect(FALLBACK_TEAMS);
            setStatus('Using fallback teams (network or API error).');
          }finally{
            refreshBtn.disabled = false;
          }
        }

        async function loadGamesForTeam(team){
          clearGames();
          if(!team) return;
          setStatus('Loading games for ' + team + '...');
          try{
            const res = await fetch(`/api/games/${encodeURIComponent(team)}`);
            if(!res.ok){
              console.warn('Failed /api/games status', res.status);
              setStatus('Could not load games for team.');
              return;
            }
            const games = await res.json();
            if(!games || !Array.isArray(games) || games.length === 0){
              setStatus('No games returned for this team. You can enter a Game ID manually.');
              return;
            }
            games.forEach(g => {
              const opt = document.createElement('option');
              opt.value = g.id;
              opt.textContent = g.label || `${g.start} - ${g.id}`;
              gameSelect.appendChild(opt);
            });
            setStatus('Choose a game or enter a Game ID manually.');
          }catch(err){
            console.error('Error loading games:', err);
            setStatus('Could not load games for team.');
          }
        }

        refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); loadTeams(); });
        teamSelect.addEventListener('change', (e)=>{ loadGamesForTeam(e.target.value); });
        gameSelect.addEventListener('change', (e)=>{ manualInput.value = e.target.value || ''; });
        form.addEventListener('submit', (e)=>{
          const sel = (gameSelect.value || '').trim();
          hiddenInput.value = sel || (manualInput.value || '').trim();
          setStatus('Generating plot... this may take a few seconds.');
        });

        // initial load
        loadTeams();
      })();
    </script>
  </body>
</html>
